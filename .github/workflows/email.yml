name: æµ‹è¯•éƒ¨ç½²
run-name: ${{ github.actor }} å¼€å§‹éƒ¨ç½² ${{ github.ref }} ğŸš€
on:
  workflow_dispatch:
    inputs:
      branchname:
        description: 'è¯·è¾“å…¥è¦éƒ¨ç½²çš„åˆ†æ”¯åç§°:'
        required: true
        default: 'release'
  # create:
  #   tags:
  #     - /^t\d+(\.\d+){1,2}(-\w+(\.\d+)?)?$/


jobs:
  deployment:
    # strategy:
    #   matrix:
    #     servers: [prod-1]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        run: |
          rm -rf ${{github.event.repository.name}}
          git clone https://${{github.repository_owner}}:${{github.token}}@github.com/${{github.repository}}
          git -C "${{github.workspace}}/${{github.event.repository.name}}" checkout ${{github.event.inputs.branchname}}
      - name: deploy to prod
        run: |
          cd /opt/xx-service
          rm -rf ${{github.event.repository.name}}
          git clone https://${{github.repository_owner}}:${{github.token}}@github.com/${{github.repository}}
          git -C "${{github.workspace}}/${{github.event.repository.name}}" checkout ${{github.event.inputs.branchname}}
          cd ${{github.event.repository.name}}
          pip3 install -r requirements.txt
          cd ..
          sudo systemctl stop 'xx-service-*'
          rm -rf src
          mv ${{github.event.repository.name}} src
          sudo systemctl start --all 'xx-service-*'
      # - name: Send mail
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.example.com
      #     server_port: 587
      #     username: ${{secrets.MAIL_USERNAME}}
      #     password: ${{secrets.MAIL_PASSWORD}}
      #     subject: XX-service çº¿ä¸Šéƒ¨ç½²é€šçŸ¥
      #     to: david@example.com
      #     body: å·²ç»æˆåŠŸå°† ${{github.repository}} ä»“åº“çš„ ${{github.event.inputs.branchname}} åˆ†æ”¯éƒ¨ç½²åˆ°çº¿ä¸Šï¼Œä½äº ${{matrix.servers}} æœåŠ¡å™¨ã€‚
      #     convert_markdown: true
      # - name: Cleanup
      #   run: |
      #     rm -rf ${{github.event.repository.name}}
